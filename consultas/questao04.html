<!DOCTYPE html>
<html lang="pt-BR"> 
  <head>
    <meta charset="utf-8">
    <title>Trabalho Js - XML</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
      console.log("oi");

      //Para carregar o arquivo XML em todos os navegadores

      function xmlLoader(url){
        if(window.XMLHttpRequest){
          var Loader = new XMLHttpRequest();
          Loader.open("GET", url ,false);
          Loader.send(null);
          return Loader.responseXML;
        }else if(window.ActiveXObject){
          var Loader = new ActiveXObject("Msxml2.DOMDocument.3.0");
          Loader.async = false;
          Loader.load(url);
          return Loader;
        }
      }

      
      function xmlQueryFilmes(xmlNode,identacao){
          topic_id_sem_hash = "thriller";//var que armazena conteúdo do GET
          var topic_id_com_hash="#"; 
          topic_id_com_hash += topic_id_sem_hash;//var que armazena conteúdo do GET com uma hashtag
          topic_id_filme="";
          var filmes_relacionados = new Array();
          var query=""; //esta var armazenara o conteudo
          var tag_atual=""; //variavel para salvar a tag atual
          var topic_id_atual="";//variavel para salvar o id do filme
          var attr_atual=""; //variavel para salvar o atributo da tag atual
          var link_filme=""; //variavel para salvar o link e não atrapalhar o caminho da arvore
          var j=0;
          query+="<center><h1>Pergunta:</h1>"
          query+="<h3>d) Quais são os sites dos filmes que são do tipo “thriller”?</h3>"
          query+="<h1>Resposta da query</h1>"
          for(var p=0;p<xmlNode.childNodes[0].childNodes.length;p++){
            if(xmlNode.childNodes[0].childNodes[p].nodeName == "association"){
              if(xmlNode.childNodes[0].childNodes[p].childNodes[1].childNodes[1].attributes[0].value == "#filme-genero"){
                if(xmlNode.childNodes[0].childNodes[p].childNodes[5].childNodes[1].attributes[0].value == topic_id_com_hash){
                  filmes_relacionados[j]=xmlNode.childNodes[0].childNodes[p].childNodes[3].childNodes[1].attributes[0].value.slice(1)
                  console.log(filmes_relacionados[j]);
                  j++;
                }  
              }
            }
            
          }

          if(xmlNode.childNodes[0].nodeType == 1){//ignorar espaços em branco
            //query = query + identacao + xmlNode.childNodes[0].nodeName + ": "
            for(var i=0;i<xmlNode.childNodes[0].childNodes.length;i++){
              tag_atual = xmlNode.childNodes[0].childNodes[i].nodeName
              if(tag_atual=="topic"){
                topic_id_atual = xmlNode.childNodes[0].childNodes[i].attributes[0].value;
                if(xmlNode.childNodes[0].childNodes[i].childNodes[1].childNodes[1].nodeName=="topicRef"){
                  attr_atual = xmlNode.childNodes[0].childNodes[i].childNodes[1].childNodes[1].attributes[0].value
                  if(attr_atual=="#Filme"){
                    if(topic_id_com_hash=="#"){
                      query = query + identacao + link_filme + xmlNode.childNodes[0].childNodes[i].childNodes[3].childNodes[1].textContent
                    }else{
                      for(var z=0; z<=filmes_relacionados.length;z++){
                        if(filmes_relacionados[z]==xmlNode.childNodes[0].childNodes[i].attributes[0].value){
                          if(xmlNode.childNodes[0].childNodes[i].childNodes[3].childNodes[1].textContent !== "Revelação"){
                            var numero_de_topicos = xmlNode.childNodes[0].childNodes[i].childNodes.length
                            query = query + identacao + xmlNode.childNodes[0].childNodes[i].childNodes[numero_de_topicos-2].childNodes[3].attributes[0].value; 
                          }else{
                            query = query + identacao + "Filme Revelação não possui site :("
                          }
                          
                        }
                      }
                    }
                  }
                }
              }
            }
          }     
            return query;
        }


        xml = xmlLoader("../xml.xml"); //carrega o xml
        document.write(xmlQueryFilmes(xml,"<br>")); //printa a query na tela
        document.write("<br><a href='questao03.html'><h3><- Questão Anterior | </a>     ");
        document.write("<a href='questao05.html'>Próxima Questão -></h3></a><br>");
    </script>
  </head>
  <body>
      <!-- Trabalho feito por Gabriel Di Domenico e Rene  -->
  </body>
</html>